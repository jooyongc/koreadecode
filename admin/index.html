<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Korea Decode CMS (AI Powered)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            --bg-body: #0f172a; /* Slate 900 */
            --bg-panel: #1e293b; /* Slate 800 */
            --bg-input: #334155; /* Slate 700 */
            --text-main: #f8fafc; /* Slate 50 */
            --text-muted: #94a3b8; /* Slate 400 */
            --accent: #6366f1; /* Indigo 500 */
            --accent-hover: #4f46e5; /* Indigo 600 */
            --border: #334155;
            --success: #10b981;
            --warning: #f59e0b;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Layout */
        .sidebar { width: 260px; background-color: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 24px; }
        .main-content { flex: 1; padding: 32px; overflow-y: auto; position: relative; }
        
        /* Components */
        .brand { font-size: 22px; font-weight: 800; margin-bottom: 40px; color: var(--text-main); letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; color: var(--text-muted); text-decoration: none; border-radius: 8px; margin-bottom: 4px; transition: 0.2s; cursor: pointer; font-weight: 500; }
        .nav-item:hover, .nav-item.active { background-color: var(--bg-input); color: var(--text-main); }
        .nav-item i { font-size: 20px; }
        
        .card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 24px; }
        
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: var(--text-muted); }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px 16px; background-color: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-main); font-size: 15px; outline: none; transition: 0.2s; font-family: inherit; }
        .form-input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        
        .btn { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-primary { background-color: var(--accent); color: white; }
        .btn-primary:hover { background-color: var(--accent-hover); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
        .btn-outline:hover { border-color: var(--text-muted); color: var(--text-main); background: var(--bg-input); }
        .btn-ai { background: linear-gradient(135deg, #8b5cf6, #d946ef); color: white; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3); }
        .btn-ai:hover { box-shadow: 0 6px 16px rgba(139, 92, 246, 0.5); transform: translateY(-1px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        /* AI Process Steps */
        .ai-step { border-left: 2px solid var(--border); padding-left: 20px; margin-bottom: 30px; position: relative; }
        .ai-step.active { border-left-color: var(--accent); }
        .ai-step-badge { position: absolute; left: -11px; top: 0; width: 20px; height: 20px; background: var(--bg-panel); border: 2px solid var(--border); border-radius: 50%; color: var(--text-muted); font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .ai-step.active .ai-step-badge { border-color: var(--accent); background: var(--accent); color: white; }
        .ai-step-title { font-size: 16px; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }

        /* Generated Options */
        .suggestion-chip { display: inline-block; padding: 6px 12px; background: var(--bg-input); border-radius: 20px; font-size: 13px; margin: 0 5px 5px 0; cursor: pointer; border: 1px solid transparent; }
        .suggestion-chip:hover { background: var(--border); }
        .suggestion-chip.selected { background: rgba(99, 102, 241, 0.2); border-color: var(--accent); color: var(--accent); }

        /* Editor Overrides */
        .ql-toolbar { background-color: var(--bg-input); border: 1px solid var(--border) !important; border-radius: 8px 8px 0 0; }
        .ql-container { background-color: rgba(0,0,0,0.2); color: var(--text-main); border: 1px solid var(--border) !important; border-top: none; border-radius: 0 0 8px 8px; font-size: 16px; height: 500px; }
        .ql-stroke { stroke: var(--text-muted) !important; }
        .ql-fill { fill: var(--text-muted) !important; }
        .ql-picker { color: var(--text-muted) !important; }

        /* Modals & Utils */
        .login-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-box { background: var(--bg-panel); width: 800px; max-height: 90vh; border-radius: 16px; padding: 24px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid var(--border); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .modal-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; overflow-y: auto; padding: 4px; }
        .modal-img-item { height: 140px; border-radius: 8px; cursor: pointer; object-fit: cover; width: 100%; transition: 0.2s; border: 2px solid transparent; }
        .modal-img-item:hover { border-color: var(--accent); transform: scale(1.02); }

        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Mobile Preview */
        .mobile-preview-container { width: 375px; height: 667px; border: 10px solid #111; border-radius: 30px; background: #fff; margin: 0 auto; overflow: hidden; position: relative; display: flex; flex-direction: column; }
        .mobile-status-bar { height: 20px; background: #111; width: 100%; }
        .mobile-body { flex: 1; overflow-y: auto; padding: 20px; color: #333; font-size: 14px; line-height: 1.6; }
        .mobile-body img { max-width: 100%; height: auto; border-radius: 8px; margin: 10px 0; }
        .mobile-body h1 { font-size: 20px; margin-bottom: 10px; line-height: 1.3; }

        /* Automation Table */
        .auto-table { width: 100%; border-collapse: collapse; }
        .auto-table th { text-align: left; padding: 12px; color: var(--text-muted); border-bottom: 1px solid var(--border); font-size: 12px; text-transform: uppercase; }
        .auto-table td { padding: 16px 12px; border-bottom: 1px solid var(--border); color: var(--text-main); font-size: 14px; }

        /* Migration Log */
        .log-box { background: #000; color: #0f0; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; border-radius: 6px; border: 1px solid var(--border); margin-top: 10px; }

        /* Image Preview Box */
        .img-preview-box { width: 100%; height: 200px; background-color: var(--bg-input); border: 2px dashed var(--border); border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; cursor: pointer; transition: 0.2s; margin-bottom: 10px; }
        .img-preview-box:hover { border-color: var(--accent); }
        .img-preview-box img { width: 100%; height: 100%; object-fit: cover; }
        .img-placeholder { text-align: center; color: var(--text-muted); font-size: 13px; }

    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-section" class="login-wrap">
        <div class="card" style="width: 400px; border: 1px solid var(--border);">
            <div style="text-align: center; margin-bottom: 24px;">
                <div class="brand" style="justify-content: center;"><i class="ph ph-command"></i> K-Decode Admin</div>
                <p style="color: var(--text-muted);">Sign in to manage content</p>
            </div>
            <div class="form-group">
                <input type="email" id="login-email" class="form-input" placeholder="Email address">
            </div>
            <div class="form-group">
                <input type="password" id="login-password" class="form-input" placeholder="Password">
            </div>
            <button class="btn btn-primary" style="width: 100%;" id="btn-login">Sign In</button>
            <p id="login-error" style="color: var(--warning); text-align: center; margin-top: 16px; font-size: 13px;"></p>
        </div>
    </div>

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="brand"><i class="ph ph-command" style="color: var(--accent);"></i> K-Decode</div>
        <nav>
            <div class="nav-item active" data-view="dashboard"><i class="ph ph-squares-four"></i> Dashboard</div>
            <div class="nav-item" data-view="ai-writer"><i class="ph ph-magic-wand"></i> AI Writer</div>
            <div class="nav-item" data-view="automation"><i class="ph ph-robot"></i> Automation</div>
            <div class="nav-item" data-view="posts"><i class="ph ph-article"></i> All Posts</div>
            <div class="nav-item" data-view="migration" style="color: #f59e0b;"><i class="ph ph-database"></i> Migration</div>
            <div class="nav-item" data-view="settings"><i class="ph ph-gear"></i> Settings</div>
        </nav>
        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border);">
            <div class="nav-item" id="btn-logout" style="color: #ef4444;"><i class="ph ph-sign-out"></i> Sign Out</div>
        </div>
    </aside>

    <!-- MAIN -->
    <main class="main-content">

        <!-- DASHBOARD -->
        <div id="view-dashboard" class="view-section active">
            <h1 style="margin-bottom: 24px;">Overview</h1>
            <div class="row" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px;">
                <div class="card">
                    <div style="color: var(--text-muted); font-size: 14px;">Total Posts</div>
                    <div style="font-size: 36px; font-weight: 700; margin-top: 8px;" id="stat-posts">0</div>
                </div>
                <div class="card">
                    <div style="color: var(--text-muted); font-size: 14px;">Total Views</div>
                    <div style="font-size: 36px; font-weight: 700; margin-top: 8px; color: var(--success);" id="stat-views">0</div>
                </div>
                <div class="card">
                    <div style="color: var(--text-muted); font-size: 14px;">Scheduled</div>
                    <div style="font-size: 36px; font-weight: 700; margin-top: 8px; color: var(--warning);" id="stat-scheduled">0</div>
                </div>
            </div>
        </div>

        <!-- AI WRITER (Also used for Editing) -->
        <div id="view-ai-writer" class="view-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h1 id="writer-heading">AI Content Creator</h1>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline" onclick="resetAI()"><i class="ph ph-plus"></i> New Post</button>
                    <button class="btn btn-ai" id="btn-seo-polish" onclick="runSEOPolish()"><i class="ph ph-sparkle"></i> AI SEO Polish</button>
                </div>
            </div>

            <div class="row" style="display: flex; gap: 40px;">
                <!-- Left: AI Controls -->
                <div style="flex: 1; max-width: 400px;">
                    
                    <!-- Step 1: Topic -->
                    <div class="ai-step active" id="step-1">
                        <div class="ai-step-badge">1</div>
                        <div class="ai-step-title">Topic &amp; Concept</div>
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select id="ai-category" class="form-select">
                                <option value="K-pop">K-Pop News</option>
                                <option value="Beauty">K-Beauty &amp; Skincare</option>
                                <option value="Travel">Travel &amp; Guides</option>
                                <option value="Food">Korean Food</option>
                                <option value="News">General News</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Topic Idea (Korean or English)</label>
                            <textarea id="ai-topic" class="form-textarea" rows="3" placeholder="Example: Best Street Food in Myeongdong"></textarea>
                        </div>
                        <button class="btn btn-ai" style="width: 100%;" onclick="runAIPhase1()">
                            <i class="ph ph-brain"></i> Generate Plan
                        </button>
                    </div>

                    <!-- Step 2: Plan -->
                    <div class="ai-step" id="step-2" style="opacity: 0.5; pointer-events: none;">
                        <div class="ai-step-badge">2</div>
                        <div class="ai-step-title">SEO Strategy</div>
                        <div class="form-group">
                            <label class="form-label">Suggested Title (English)</label>
                            <input type="text" id="ai-suggested-title" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Keywords</label>
                            <div id="ai-keywords-container"></div>
                        </div>
                        <button class="btn btn-primary" style="width: 100%;" onclick="runAIPhase2()">
                            <i class="ph ph-pen-nib"></i> Write Full Article with Media
                        </button>
                    </div>

                    <!-- Step 3: Visuals (Manual Override) -->
                    <div class="ai-step" id="step-3" style="opacity: 0.5; pointer-events: none;">
                        <div class="ai-step-badge">3</div>
                        <div class="ai-step-title">Featured Image</div>
                        <div class="img-preview-box" id="ai-img-preview-box">
                            <img id="selected-ai-img" style="display: none;">
                            <div class="img-placeholder" id="ai-img-placeholder">
                                Auto-selected by AI<br>Click to change
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Search Replacement</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="ai-img-query" class="form-input">
                                <button class="btn btn-outline" onclick="searchUnsplashAI()">Search</button>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Right: Editor & Output -->
                <div style="flex: 2; display: flex; flex-direction: column;">
                    <div class="card" style="flex: 1; display: flex; flex-direction: column; padding: 0; overflow: hidden;">
                        <div style="padding: 16px; border-bottom: 1px solid var(--border); background: var(--bg-input); display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600;">Editor</span>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-outline" style="padding: 6px 12px; font-size: 12px;" onclick="showMobilePreview()">
                                    <i class="ph ph-device-mobile"></i> Preview
                                </button>
                                <button class="btn btn-primary" id="btn-save-post" style="padding: 6px 12px; font-size: 12px;" onclick="publishPost()">
                                    <i class="ph ph-paper-plane-right"></i> Publish
                                </button>
                            </div>
                        </div>
                        
                        <!-- Quill Editor -->
                        <div id="editor-container"></div>
                    </div>

                    <!-- Scheduling -->
                    <div class="card" style="padding: 16px;">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div style="flex: 1;">
                                <label class="form-label">Schedule Publish (Optional)</label>
                                <input type="datetime-local" id="post-schedule" class="form-input">
                            </div>
                            <div style="flex: 1;">
                                <label class="form-label">SEO Score</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="flex: 1; height: 8px; background: var(--bg-input); border-radius: 4px; overflow: hidden;">
                                        <div id="seo-bar" style="width: 0%; height: 100%; background: var(--warning); transition: 0.5s;"></div>
                                    </div>
                                    <span id="seo-score-text" style="font-size: 14px; font-weight: bold;">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AUTOMATION -->
        <div id="view-automation" class="view-section">
            <h1 style="margin-bottom: 24px;">Bulk Automation</h1>
            <div class="row" style="gap: 40px;">
                <div style="flex: 1; max-width: 400px;">
                    <div class="card">
                        <h3>Schedule Settings</h3>
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select id="auto-category" class="form-select">
                                <option value="News">News</option>
                                <option value="K-pop">K-Pop</option>
                                <option value="Food">Food</option>
                                <option value="Travel">Travel</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="datetime-local" id="auto-start-date" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Interval</label>
                            <select id="auto-interval" class="form-select">
                                <option value="24">Every 24 Hours (Daily)</option>
                                <option value="12">Every 12 Hours</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Topics</label>
                            <textarea id="auto-topics" class="form-textarea" rows="10"></textarea>
                        </div>
                        <button class="btn btn-ai" style="width: 100%;" onclick="runAutomation()">
                            <i class="ph ph-robot"></i> Schedule All
                        </button>
                    </div>
                </div>
                <div style="flex: 2;">
                    <div class="card">
                        <h3>Queue</h3>
                        <table class="auto-table">
                            <thead><tr><th>Status</th><th>Title</th><th>Scheduled</th><th>Action</th></tr></thead>
                            <tbody id="auto-queue-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- MIGRATION -->
        <div id="view-migration" class="view-section">
            <h1>Legacy Post Migration</h1>
            <div class="card">
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="startMigration()">Start Migration</button>
                    <span id="migration-status" style="margin-left: 10px; font-weight: bold;"></span>
                </div>
                <label class="form-label">Migration Log</label>
                <div id="migration-log" class="log-box"></div>
            </div>
        </div>

        <!-- POSTS LIST -->
        <div id="view-posts" class="view-section">
            <h1 style="margin-bottom: 24px;">Content Library</h1>
            <div id="posts-grid" style="display: grid; gap: 16px;"></div>
        </div>

        <!-- SETTINGS -->
        <div id="view-settings" class="view-section">
            <h1 style="margin-bottom: 24px;">Settings</h1>
            <div class="card" style="max-width: 600px;">
                <div class="form-group">
                    <label class="form-label">API Key</label>
                    <input type="password" id="setting-openai-key" class="form-input">
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">Save</button>
                <hr style="border-top: 1px solid var(--border); margin: 20px 0;">
                <h3 style="margin-bottom: 10px; color: var(--warning);">Maintenance</h3>
                <button class="btn btn-outline" style="border-color: var(--warning); color: var(--warning);" onclick="removeDuplicates()">Remove Duplicate Posts</button>
            </div>
        </div>

    </main>

    <!-- MODALS -->
    <div id="modal-unsplash" class="modal-overlay">
        <div class="modal-box">
            <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                <h3 style="margin: 0;">Unsplash Images</h3>
                <button class="btn btn-outline" style="padding: 4px 10px;" onclick="closeModal('modal-unsplash')"><i class="ph ph-x"></i></button>
            </div>
            <div id="unsplash-results" class="modal-grid"></div>
        </div>
    </div>

    <div id="modal-preview" class="modal-overlay">
        <div class="mobile-preview-container">
            <div class="mobile-status-bar"></div>
            <div class="mobile-body">
                <div style="position: sticky; top: 0; background: #fff; padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 15px;">
                    <span style="font-size: 12px; color: #666; text-transform: uppercase; font-weight: 700;" id="prev-cat">CATEGORY</span>
                </div>
                <h1 id="prev-title">Post Title</h1>
                <div style="font-size: 12px; color: #999; margin-bottom: 20px;">By Korea Decode</div>
                <img id="prev-img" src="" style="display: none;">
                <div id="prev-content"></div>
            </div>
            <div style="padding: 15px; background: #f9f9f9; text-align: center;">
                <button class="btn btn-primary" onclick="closeModal('modal-preview')" style="width: 100%;">Close</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db, storage, signInWithEmailAndPassword, onAuthStateChanged, signOut, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, ref, uploadBytes, getDownloadURL, getDoc } from '/js/firebase-config.js';
        import { migrationList } from '/js/migration-list.js';

        const UNSPLASH_ACCESS_KEY = 'TMpRwGXIoEuszwIoROwgwukRP5iqf08ej2mk4Pdbz8s';
        let quill;
        let activeImage = '';
        let currentUser = null;
        let editingPostId = null; // Track ID for edits

        function init() {
            quill = new Quill('#editor-container', {
                theme: 'snow',
                modules: { toolbar: [[{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline', 'blockquote'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['link', 'clean']] }
            });
            quill.on('text-change', calculateSEOScore);

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('login-section').style.display = 'none';
                    loadDashboard();
                    loadQueue();
                } else {
                    document.getElementById('login-section').style.display = 'flex';
                }
            });

            document.querySelectorAll('.nav-item[data-view]').forEach(el => {
                el.addEventListener('click', () => switchView(el.dataset.view));
            });
            document.getElementById('btn-login').addEventListener('click', doLogin);
            document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

            const savedKey = localStorage.getItem('openai_key');
            if(savedKey) document.getElementById('setting-openai-key').value = savedKey;

            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('auto-start-date').value = now.toISOString().slice(0,16);
        }

        window.switchView = (viewName) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.nav-item[data-view="${viewName}"]`).classList.add('active');
            
            if(viewName === 'posts') loadPosts();
            if(viewName === 'dashboard') loadDashboard();
            if(viewName === 'automation') loadQueue();
            if(viewName === 'ai-writer') {
                if(!editingPostId) resetAI(); // Only reset if not editing
            }
        };

        async function doLogin() {
            const e = document.getElementById('login-email').value;
            const p = document.getElementById('login-password').value;
            try { await signInWithEmailAndPassword(auth, e, p); }
            catch(err) { document.getElementById('login-error').innerText = err.message; }
        }

        window.saveSettings = () => {
            const k = document.getElementById('setting-openai-key').value;
            localStorage.setItem('openai_key', k);
            alert('Settings Saved');
        };

        window.closeModal = (id) => document.getElementById(id).style.display = 'none';

        // --- DUPLICATE REMOVAL ---
        window.removeDuplicates = async () => {
            if(!confirm("This will delete duplicate posts (keeping oldest). Continue?")) return;
            const btn = document.querySelector('button[onclick="removeDuplicates()"]');
            btn.innerText = "Processing...";
            btn.disabled = true;
            try {
                const q = query(collection(db, "posts"), orderBy("createdAt", "asc"));
                const snap = await getDocs(q);
                const seen = new Set();
                let count = 0;
                for (const d of snap.docs) {
                    const t = d.data().title;
                    if (seen.has(t)) { await deleteDoc(doc(db, "posts", d.id)); count++; }
                    else seen.add(t);
                }
                alert(`Deleted ${count} duplicates.`);
            } catch (e) { alert("Error: " + e.message); }
            finally { btn.innerText = "Remove Duplicate Posts"; btn.disabled = false; }
        };

        // --- EDITING ---
        window.editPost = async (id) => {
            editingPostId = id;
            switchView('ai-writer');
            
            // UI Update
            document.getElementById('writer-heading').innerText = "Edit Post";
            document.getElementById('btn-save-post').innerHTML = '<i class="ph ph-floppy-disk"></i> Update';
            
            // Load Data
            const docRef = doc(db, "posts", id);
            const docSnap = await getDoc(docRef);
            if(docSnap.exists()) {
                const p = docSnap.data();
                document.getElementById('ai-suggested-title').value = p.title;
                document.getElementById('ai-category').value = p.category;
                quill.clipboard.dangerouslyPasteHTML(p.content);
                activeImage = p.image;
                if(activeImage) {
                    document.getElementById('selected-ai-img').src = activeImage;
                    document.getElementById('selected-ai-img').style.display = 'block';
                    document.getElementById('ai-img-placeholder').style.display = 'none';
                }
                // Skip steps
                document.getElementById('step-1').classList.remove('active');
                document.getElementById('step-2').style.opacity = '1';
                document.getElementById('step-2').style.pointerEvents = 'auto';
                document.getElementById('step-2').classList.remove('active');
                document.getElementById('step-3').style.opacity = '1';
                document.getElementById('step-3').style.pointerEvents = 'auto';
                document.getElementById('step-3').classList.add('active');
            }
        };

        // --- AI WORKFLOW & PERSONA ---
        window.resetAI = () => {
            editingPostId = null;
            document.getElementById('writer-heading').innerText = "AI Content Creator";
            document.getElementById('btn-save-post').innerHTML = '<i class="ph ph-paper-plane-right"></i> Publish';
            
            document.getElementById('step-1').classList.add('active');
            document.getElementById('step-2').style.opacity = '0.5';
            document.getElementById('step-2').style.pointerEvents = 'none';
            document.getElementById('step-3').style.opacity = '0.5';
            document.getElementById('ai-topic').value = '';
            document.getElementById('ai-suggested-title').value = '';
            document.getElementById('ai-keywords-container').innerHTML = '';
            quill.setText('');
            activeImage = '';
            document.getElementById('selected-ai-img').style.display = 'none';
            document.getElementById('ai-img-placeholder').style.display = 'block';
        };

        window.runAIPhase1 = async () => {
            const topic = document.getElementById('ai-topic').value;
            if(!topic) return alert('Please enter a topic');
            const btn = document.querySelector('#step-1 .btn-ai');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="ph ph-spinner spinner"></i> Thinking...';
            setTimeout(() => {
                const title = `Friendly Guide to ${topic}: Local Secrets (2026)`;
                const keywords = ["Korea Travel", "Local Life", topic, "Tips"];
                document.getElementById('ai-suggested-title').value = title;
                const kwContainer = document.getElementById('ai-keywords-container');
                kwContainer.innerHTML = '';
                keywords.forEach(k => kwContainer.innerHTML += `<span class="suggestion-chip selected">${k}</span>`);
                document.getElementById('step-1').classList.remove('active');
                document.getElementById('step-2').style.opacity = '1';
                document.getElementById('step-2').style.pointerEvents = 'auto';
                document.getElementById('step-2').classList.add('active');
                document.getElementById('ai-img-query').value = topic + " aesthetic";
                btn.innerHTML = originalText;
            }, 1500);
        };

        window.runAIPhase2 = async () => {
            const title = document.getElementById('ai-suggested-title').value;
            const topic = document.getElementById('ai-topic').value;
            const btn = document.querySelector('#step-2 .btn-primary');
            btn.innerHTML = '<i class="ph ph-spinner spinner"></i> Writing as your friend...';

            let contentImages = [];
            try {
                const res = await fetch(`https://api.unsplash.com/search/photos?page=1&per_page=3&query=${topic}&client_id=${UNSPLASH_ACCESS_KEY}`);
                const data = await res.json();
                if(data.results && data.results.length > 0) {
                    activeImage = data.results[0].urls.regular;
                    document.getElementById('selected-ai-img').src = activeImage;
                    document.getElementById('selected-ai-img').style.display = 'block';
                    document.getElementById('ai-img-placeholder').style.display = 'none';
                    contentImages = data.results.slice(1).map(img => img.urls.regular);
                }
            } catch(e) {}

            setTimeout(() => {
                let imgHtml = '';
                contentImages.forEach(src => {
                    imgHtml += `<img src="${src}" alt="${title}" style="width:100%; border-radius:8px; margin: 20px 0;"><br>`;
                });

                // PERSONA: 5-year Expat Friend
                const content = `
                    <p>Hey guys! It's your friend in Seoul again. ðŸ‘‹</p>
                    <p>Living here for 5 years, I've seen a lot of trends come and go, but <strong>${topic}</strong> is something you really can't miss right now.</p>
                    <br>
                    <h2>Why I Recommend This</h2>
                    <p>Honestly, when I first moved here, I didn't get the hype. But after trying it myself, I get it. It's not just about the photos (though they look amazing), it's about the vibe.</p>
                    <br>
                    ${imgHtml}
                    <br>
                    <h3>My Personal Tips</h3>
                    <ul>
                        <li><strong>Go early:</strong> It gets super crowded on weekends.</li>
                        <li><strong>Ask locals:</strong> Don't be afraid to use Papago to translate!</li>
                        <li><strong>Hidden Gem:</strong> Look for the small alleyway next to the main street.</li>
                    </ul>
                    <br>
                    <p>Let me know in the comments if you check it out! Catch you later. ðŸ˜‰</p>
                `;
                
                quill.clipboard.dangerouslyPasteHTML(content);
                
                document.getElementById('step-2').classList.remove('active');
                document.getElementById('step-3').style.opacity = '1';
                document.getElementById('step-3').style.pointerEvents = 'auto';
                document.getElementById('step-3').classList.add('active');
                btn.innerHTML = '<i class="ph ph-check"></i> Done';
            }, 2000);
        };

        window.runSEOPolish = () => {
            const btn = document.getElementById('btn-seo-polish');
            btn.innerHTML = '<i class="ph ph-spinner spinner"></i> Polishing...';
            setTimeout(() => {
                let title = document.getElementById('ai-suggested-title').value;
                // Add catchy SEO words if missing
                if(!title.includes("2026")) title += " (Updated 2026)";
                if(!title.includes("Guide") && !title.includes("Review")) title = "Ultimate Guide: " + title;
                document.getElementById('ai-suggested-title').value = title;
                
                // Ensure intro paragraph exists in content
                let content = quill.root.innerHTML;
                if(!content.includes("In this article")) {
                    content = `<p><em>In this article, we'll explore ${title} and why it's a must-visit.</em></p>` + content;
                    quill.clipboard.dangerouslyPasteHTML(content);
                }
                
                alert("SEO Polish Complete! Title and Intro optimized.");
                calculateSEOScore();
                btn.innerHTML = '<i class="ph ph-sparkle"></i> AI SEO Polish';
            }, 1000);
        };

        window.searchUnsplashAI = async () => {
            const q = document.getElementById('ai-img-query').value;
            const container = document.getElementById('unsplash-results');
            container.innerHTML = '<div style="grid-column:1/-1;text-align:center;">Searching...</div>';
            document.getElementById('modal-unsplash').style.display = 'flex';
            try {
                const res = await fetch(`https://api.unsplash.com/search/photos?page=1&per_page=12&query=${q}&client_id=${UNSPLASH_ACCESS_KEY}`);
                const data = await res.json();
                container.innerHTML = '';
                data.results.forEach(img => {
                    const el = document.createElement('img');
                    el.src = img.urls.small;
                    el.className = 'modal-img-item';
                    el.onclick = () => {
                        activeImage = img.urls.regular;
                        document.getElementById('selected-ai-img').src = activeImage;
                        document.getElementById('selected-ai-img').style.display = 'block';
                        document.getElementById('ai-img-placeholder').style.display = 'none';
                        document.getElementById('modal-unsplash').style.display = 'none';
                    };
                    container.appendChild(el);
                });
            } catch(e) { container.innerHTML = 'API Error'; }
        };

        window.runAutomation = async () => {
            const topics = document.getElementById('auto-topics').value.split('\n').filter(t => t.trim() !== '');
            const category = document.getElementById('auto-category').value;
            const startStr = document.getElementById('auto-start-date').value;
            const intervalHours = parseInt(document.getElementById('auto-interval').value);
            if(topics.length === 0) return alert('Enter topics');
            if(!startStr) return alert('Select start date');
            const btn = document.querySelector('#view-automation .btn-ai');
            btn.innerHTML = '<i class="ph ph-spinner spinner"></i> Scheduling...';
            let currentDate = new Date(startStr);
            for (const topic of topics) {
                const title = `[Auto] ${topic} - Korea Decode Report`;
                const content = `<p>Automatically generated article about <strong>${topic}</strong>.</p>`;
                let imgUrl = '';
                try {
                    const res = await fetch(`https://api.unsplash.com/search/photos?page=1&per_page=1&query=${topic}&client_id=${UNSPLASH_ACCESS_KEY}`);
                    const data = await res.json();
                    if(data.results.length > 0) imgUrl = data.results[0].urls.regular;
                } catch(e) {}
                await addDoc(collection(db, "posts"), {
                    title, category, content, image: imgUrl, views: 0,
                    createdAt: new Date(currentDate), status: 'scheduled'
                });
                currentDate.setHours(currentDate.getHours() + intervalHours);
            }
            alert(`Successfully scheduled ${topics.length} posts!`);
            document.getElementById('auto-topics').value = '';
            btn.innerHTML = '<i class="ph ph-robot"></i> Generate & Schedule All';
            loadQueue();
        };

        async function loadQueue() {
            const tbody = document.getElementById('auto-queue-list');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Loading...</td></tr>';
            const q = query(collection(db, "posts"), orderBy("createdAt", "asc"));
            const snap = await getDocs(q);
            const now = new Date();
            tbody.innerHTML = '';
            snap.forEach(doc => {
                const p = doc.data();
                const pDate = p.createdAt.toDate();
                if (pDate > now) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td><span style="padding:4px 8px; background:#f59e0b20; color:#f59e0b; font-size:12px;">Scheduled</span></td><td>${p.title}</td><td>${pDate.toLocaleString()}</td><td><button class="btn btn-outline" style="padding:4px 8px; font-size:12px;" onclick="deletePost('${doc.id}')">Cancel</button></td>`;
                    tbody.appendChild(tr);
                }
            });
            if(tbody.innerHTML === '') tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#888;">No scheduled posts.</td></tr>';
        }

        window.deletePost = async (id) => {
            if(confirm('Cancel this post?')) { await deleteDoc(doc(db, "posts", id)); loadQueue(); }
        }

        function calculateSEOScore() {
            let score = 0;
            const text = quill.getText();
            const title = document.getElementById('ai-suggested-title').value;
            if(text.trim().split(/\s+/).length > 300) score += 50;
            if(title.length >= 10) score += 50;
            document.getElementById('seo-bar').style.width = score + '%';
            document.getElementById('seo-score-text').innerText = score + '%';
        }

        window.showMobilePreview = () => {
            document.getElementById('prev-cat').innerText = document.getElementById('ai-category').value;
            document.getElementById('prev-title').innerText = document.getElementById('ai-suggested-title').value;
            document.getElementById('prev-img').src = activeImage;
            document.getElementById('prev-img').style.display = activeImage ? 'block' : 'none';
            document.getElementById('prev-content').innerHTML = quill.root.innerHTML;
            document.getElementById('modal-preview').style.display = 'flex';
        };

        window.publishPost = async () => {
            const title = document.getElementById('ai-suggested-title').value;
            const category = document.getElementById('ai-category').value;
            const content = quill.root.innerHTML;
            const schedule = document.getElementById('post-schedule').value;
            
            try {
                if (editingPostId) {
                    await updateDoc(doc(db, "posts", editingPostId), {
                        title, category, content, image: activeImage
                    });
                    alert('Post Updated!');
                } else {
                    await addDoc(collection(db, "posts"), {
                        title, category, content, image: activeImage, views: 0,
                        createdAt: schedule ? new Date(schedule) : serverTimestamp(),
                        status: schedule ? 'scheduled' : 'published'
                    });
                    alert('Post Published!');
                }
                resetAI();
            } catch(e) { alert(e.message); }
        };

        async function loadDashboard() {
            const snap = await getDocs(collection(db, "posts"));
            document.getElementById('stat-posts').innerText = snap.size;
        }

        async function loadPosts() {
            const grid = document.getElementById('posts-grid');
            grid.innerHTML = 'Loading...';
            const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
            const snap = await getDocs(q);
            grid.innerHTML = '';
            snap.forEach(doc => {
                const p = doc.data();
                const div = document.createElement('div');
                div.className = 'card';
                div.style.padding = '16px';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:700; font-size:16px;">${p.title}</div>
                            <div style="font-size:12px; color:var(--text-muted); margin-top:4px;">
                                ${p.category} â€¢ ${p.views || 0} views
                            </div>
                        </div>
                        <div style="display:flex; gap: 8px;">
                            <a href="/post.html?id=${doc.id}" target="_blank" class="btn btn-outline" style="padding:6px 12px; font-size:12px;">View</a>
                            <button class="btn btn-outline" style="padding:6px 12px; font-size:12px; color:var(--accent); border-color:var(--accent);" onclick="editPost('${doc.id}')">Edit</button>
                        </div>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        // --- MIGRATION LOGIC (Previous) ---
        window.startMigration = async () => {
             // ... (Keep existing migration logic)
             // Re-implementing simplified logic here for overwrite consistency
             const logBox = document.getElementById('migration-log');
             logBox.innerHTML = 'Starting... (Check console for full details)';
             const parser = new DOMParser();
             for (const path of migrationList) {
                try {
                    const res = await fetch(path);
                    if (!res.ok) continue;
                    const html = await res.text();
                    const doc = parser.parseFromString(html, 'text/html');
                    let title = doc.querySelector('title')?.innerText.split(' - ')[0] || "Untitled";
                    let contentEl = doc.querySelector('.elementor-widget-theme-post-content') || doc.querySelector('article') || doc.body;
                    let content = contentEl.innerHTML;
                    
                    content = content.replace(/http:\/\/koreadecode.mycafe24.com/g, '');
                    content = content.replace(/https:\/\/koreadecode.mycafe24.com/g, '');
                    content = content.replace(/<script\b[^>]*>([\s\S]*?)<\/script>/gm, "");
                    content = content.replace(/<style\b[^>]*>([\s\S]*?)<\/style>/gm, "");

                    await addDoc(collection(db, "posts"), {
                        title, category: 'Archive', content, 
                        image: 'https://images.unsplash.com/photo-1576085898323-218337e3e43c?w=800',
                        views: 0, createdAt: serverTimestamp(), status: 'published'
                    });
                    logBox.innerHTML += `> Imported ${title}\n`;
                } catch(e) {}
             }
             alert('Migration Done');
        };

        init();
    </script>
</body>
</html>